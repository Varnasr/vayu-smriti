<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vayu Smriti वायु स्मृति | India's Air Quality Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary: #7C3AED; --primary-light: #A78BFA; --accent: #F59E0B;
            --text: #1F2937; --text-2: #4B5563; --text-3: #9CA3AF;
            --bg: #F8FAFC; --card: #FFFFFF; --border: #E2E8F0;
            --health: #EF4444; --policy: #3B82F6; --research: #10B981;
            --aqi-good: #22C55E; --aqi-mod: #EAB308; --aqi-poor: #F97316; 
            --aqi-vpoor: #EF4444; --aqi-severe: #7C3AED; --aqi-hazard: #831843;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        [data-theme="dark"] {
            --text: #F1F5F9; --text-2: #CBD5E1; --text-3: #64748B;
            --bg: #0F172A; --card: #1E293B; --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; font-size: 14px; }

        /* SARGAM-STYLE ICONS - 24x24 stroke-based */
        .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 1.5; fill: none; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }
        .icon-sm { width: 16px; height: 16px; }
        .icon-lg { width: 24px; height: 24px; }

        /* HEADER */
        .header { background: var(--card); border-bottom: 1px solid var(--border); padding: 0.625rem 1rem; position: sticky; top: 0; z-index: 1000; }
        .header-inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .logo { display: flex; align-items: center; gap: 0.5rem; }
        .logo-mark { width: 32px; height: 32px; background: var(--gradient); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .logo-mark .icon { stroke: white; }
        .logo h1 { font-size: 1rem; font-weight: 700; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .btn { padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: none; font-family: inherit; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.375rem; background: var(--card); color: var(--text-2); border: 1px solid var(--border); }
        .btn:hover { border-color: var(--primary); color: var(--primary); }
        .btn-primary { background: var(--gradient); color: white; border: none; }
        .btn-sm { padding: 0.375rem 0.5rem; font-size: 0.6875rem; }

        /* TICKER */
        .ticker { background: linear-gradient(90deg, #1E293B, #0F172A); padding: 0.5rem 1rem; }
        .ticker-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; gap: 0.75rem; }
        .ticker-label { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 1px; color: #94A3B8; display: flex; align-items: center; gap: 0.375rem; white-space: nowrap; }
        .pulse { width: 6px; height: 6px; background: #EF4444; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .ticker-scroll { display: flex; gap: 0.75rem; flex: 1; overflow-x: auto; scrollbar-width: none; }
        .ticker-scroll::-webkit-scrollbar { display: none; }
        .ticker-item { display: flex; align-items: center; gap: 0.25rem; flex-shrink: 0; }
        .ticker-city { font-size: 0.6875rem; color: #CBD5E1; }
        .ticker-aqi { font-size: 0.6875rem; font-weight: 700; padding: 0.125rem 0.375rem; border-radius: 3px; min-width: 32px; text-align: center; color: white; }
        .ticker-aqi.good { background: var(--aqi-good); } .ticker-aqi.mod { background: var(--aqi-mod); color: #1F2937; }
        .ticker-aqi.poor { background: var(--aqi-poor); } .ticker-aqi.vpoor { background: var(--aqi-vpoor); } 
        .ticker-aqi.severe { background: var(--aqi-severe); } .ticker-aqi.hazard { background: var(--aqi-hazard); }
        .ticker-meta { font-size: 0.5625rem; color: #64748B; white-space: nowrap; }

        /* TABS - Scrollable on mobile */
        .tabs { background: var(--card); border-bottom: 1px solid var(--border); overflow-x: auto; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .tabs::-webkit-scrollbar { display: none; }
        .tabs-inner { max-width: 1200px; margin: 0 auto; display: flex; padding: 0 1rem; min-width: max-content; }
        .tab { padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 500; color: var(--text-2); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; display: flex; align-items: center; gap: 0.375rem; transition: all 0.15s; }
        .tab:hover { color: var(--text); background: var(--bg); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab .icon { width: 16px; height: 16px; }

        /* MAIN */
        .main { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .panel { display: none; }
        .panel.active { display: block; }

        /* RESPONSIVE GRIDS */
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .grid-2-mobile { grid-template-columns: repeat(2, 1fr); }
        }
        @media (min-width: 769px) and (max-width: 1024px) {
            .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        /* CARDS */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .card-header { padding: 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .card-title { font-size: 0.8125rem; font-weight: 600; display: flex; align-items: center; gap: 0.375rem; }
        .card-title .icon { color: var(--primary); }
        .card-body { padding: 0.75rem; }
        .card-footer { padding: 0.5rem 0.75rem; border-top: 1px solid var(--border); background: var(--bg); font-size: 0.625rem; color: var(--text-3); }

        /* STAT CARDS */
        .stat-card { text-align: center; padding: 1rem 0.75rem; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); line-height: 1.2; }
        @media (min-width: 769px) { .stat-value { font-size: 1.75rem; } }
        .stat-value.danger { color: var(--health); }
        .stat-value.warning { color: var(--accent); }
        .stat-value.success { color: var(--research); }
        .stat-label { font-size: 0.625rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 0.25rem; }

        /* FORMS */
        .form-group { margin-bottom: 0.75rem; }
        .form-label { display: block; font-size: 0.625rem; font-weight: 600; color: var(--text-2); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input, .form-select { width: 100%; padding: 0.5rem 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; background: var(--card); color: var(--text); font-family: inherit; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
        .form-range { width: 100%; accent-color: var(--primary); }
        .form-hint { font-size: 0.625rem; color: var(--text-3); margin-top: 0.25rem; }

        /* TABLES - Responsive */
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table { width: 100%; border-collapse: collapse; font-size: 0.75rem; min-width: 500px; }
        .table th, .table td { padding: 0.5rem 0.625rem; text-align: left; border-bottom: 1px solid var(--border); }
        .table th { font-weight: 600; color: var(--text-2); text-transform: uppercase; font-size: 0.625rem; letter-spacing: 0.5px; background: var(--bg); position: sticky; top: 0; }
        .table tr:hover { background: var(--bg); }

        /* BADGES */
        .badge { display: inline-block; padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.5625rem; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: #D1FAE5; color: #065F46; }
        .badge-warning { background: #FEF3C7; color: #92400E; }
        .badge-danger { background: #FEE2E2; color: #991B1B; }
        .badge-info { background: #DBEAFE; color: #1E40AF; }

        /* RESULT BOX */
        .result-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem; }
        .result-title { font-size: 0.625rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem; }
        .result-value { font-size: 1.25rem; font-weight: 700; }
        .result-detail { font-size: 0.6875rem; color: var(--text-2); margin-top: 0.375rem; }

        /* MAP */
        #india-map { height: 350px; border-radius: 8px; }
        @media (min-width: 769px) { #india-map { height: 450px; } }

        /* CHART */
        .chart-container { height: 200px; }
        @media (min-width: 769px) { .chart-container { height: 250px; } }

        /* CODE BOX */
        .code-box { background: #1E293B; color: #E2E8F0; padding: 0.75rem; border-radius: 6px; font-family: 'SF Mono', Monaco, monospace; font-size: 0.6875rem; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }

        /* TIMELINE */
        .timeline-item { display: flex; gap: 0.625rem; padding: 0.625rem 0; border-bottom: 1px solid var(--border); }
        .timeline-item:last-child { border-bottom: none; }
        .timeline-date { font-size: 0.5625rem; color: var(--text-3); min-width: 50px; flex-shrink: 0; }
        .timeline-content { flex: 1; min-width: 0; }
        .timeline-title { font-size: 0.75rem; font-weight: 500; }
        .timeline-desc { font-size: 0.625rem; color: var(--text-2); margin-top: 0.125rem; }

        /* GRAP LEVELS */
        .grap-level { padding: 0.5rem 0.625rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.6875rem; }
        .grap-level:last-child { margin-bottom: 0; }
        .grap-1 { background: #D1FAE5; }
        .grap-2 { background: #FEF3C7; }
        .grap-3 { background: #FED7AA; }
        .grap-4 { background: #FEE2E2; }

        /* RESOURCE LINKS */
        .resource-link { display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.75rem; }
        .resource-link:last-child { border-bottom: none; }
        .resource-link a { color: var(--primary); text-decoration: none; }
        .resource-link a:hover { text-decoration: underline; }

        /* FOOTER */
        .footer { background: var(--card); border-top: 1px solid var(--border); padding: 1rem; margin-top: 1.5rem; text-align: center; font-size: 0.6875rem; color: var(--text-2); }
        .footer a { color: var(--primary); text-decoration: none; }

        /* MOBILE UTILITIES */
        @media (max-width: 768px) {
            .hide-mobile { display: none !important; }
            .header h1 { font-size: 0.875rem; }
            .tab { padding: 0.625rem 0.75rem; font-size: 0.6875rem; }
            .main { padding: 0.75rem; }
            .card-body { padding: 0.625rem; }
        }
        @media (min-width: 769px) {
            .hide-desktop { display: none !important; }
        }

        /* STACK ON MOBILE */
        .stack-mobile { display: flex; flex-direction: column; gap: 0.5rem; }
        @media (min-width: 769px) {
            .stack-mobile { flex-direction: row; align-items: flex-end; }
            .stack-mobile > * { flex: 1; }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-inner">
            <div class="logo">
                <div class="logo-mark">
                    <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 2"/></svg>
                </div>
                <h1>Vayu Smriti <span class="hide-mobile">वायु स्मृति</span></h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-sm" onclick="toggleTheme()" title="Toggle theme">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
                <button class="btn btn-sm hide-mobile" onclick="exportData('csv')">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                    <span>Export</span>
                </button>
            </div>
        </div>
    </header>

    <!-- TICKER -->
    <div class="ticker">
        <div class="ticker-inner">
            <div class="ticker-label"><span class="pulse"></span> <span class="hide-mobile">LIVE</span> AQI</div>
            <div class="ticker-scroll" id="aqi-ticker"><div class="ticker-item"><span class="ticker-city">Connecting...</span></div></div>
            <button class="btn btn-sm" onclick="fetchAllAQI()" style="background: #334155; color: #CBD5E1; border: none; padding: 0.25rem 0.5rem;">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            </button>
            <div class="ticker-meta hide-mobile" id="ticker-update"></div>
        </div>
    </div>

    <!-- TABS -->
    <nav class="tabs">
        <div class="tabs-inner">
            <div class="tab active" onclick="showPanel('dashboard')">
                <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                <span>Dashboard</span>
            </div>
            <div class="tab" onclick="showPanel('health')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                <span>Health</span>
            </div>
            <div class="tab" onclick="showPanel('economic')">
                <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                <span>Economic</span>
            </div>
            <div class="tab" onclick="showPanel('policy')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                <span>Policy</span>
            </div>
            <div class="tab" onclick="showPanel('compare')">
                <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                <span>Compare</span>
            </div>
            <div class="tab" onclick="showPanel('map')">
                <svg class="icon" viewBox="0 0 24 24"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                <span>Map</span>
            </div>
            <div class="tab" onclick="showPanel('history')">
                <svg class="icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                <span>Trends</span>
            </div>
            <div class="tab" onclick="showPanel('accountability')">
                <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                <span>Accountability</span>
            </div>
            <div class="tab" onclick="showPanel('tools')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                <span>Tools</span>
            </div>
            <div class="tab" onclick="showPanel('resources')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                <span>Resources</span>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="main">
        <!-- DASHBOARD -->
        <div class="panel active" id="panel-dashboard">
            <div class="grid grid-4 grid-2-mobile" style="margin-bottom: 1rem;">
                <div class="card stat-card">
                    <div class="stat-value danger">2.1M</div>
                    <div class="stat-label">Deaths/Year India</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value warning">4.2L Cr</div>
                    <div class="stat-label">Annual Loss (INR)</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value danger">0</div>
                    <div class="stat-label">Good Days Delhi '25</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="delhi-live-aqi">--</div>
                    <div class="stat-label">Delhi Live AQI</div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            Metro Cities AQI
                        </h3>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="metroChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/></svg>
                            North vs South
                        </h3>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="regionChart"></canvas></div></div>
                </div>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        Safe Hours Calculator
                    </h3>
                </div>
                <div class="card-body">
                    <div class="stack-mobile">
                        <div class="form-group">
                            <label class="form-label">Current AQI</label>
                            <input type="number" class="form-input" id="safe-aqi" value="285" min="0" max="999">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Activity</label>
                            <select class="form-select" id="safe-activity">
                                <option value="1">Light</option>
                                <option value="2" selected>Moderate</option>
                                <option value="3">Heavy</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Health</label>
                            <select class="form-select" id="safe-health">
                                <option value="1" selected>Healthy</option>
                                <option value="1.5">Sensitive</option>
                                <option value="2">High Risk</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary" onclick="calculateSafeHours()" style="width: 100%;">Calculate</button>
                        </div>
                    </div>
                    <div class="result-box" id="safe-result" style="display: none;">
                        <div class="result-title">Max Outdoor Time</div>
                        <div class="result-value" id="safe-hours">--</div>
                        <div class="result-detail" id="safe-advice"></div>
                    </div>
                </div>
                <div class="card-footer">Based on WHO exposure guidelines. Advisory only.</div>
            </div>
        </div>

        <!-- HEALTH -->
        <div class="panel" id="panel-health">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                            Health Risk Calculator
                        </h3>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.6875rem; color: var(--text-3); margin-bottom: 0.75rem;">Based on Global Exposure Mortality Model (GEMM)</p>
                        <div class="form-group">
                            <label class="form-label">Age</label>
                            <input type="number" class="form-input" id="health-age" value="35" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Annual PM2.5 Exposure (ug/m3)</label>
                            <input type="number" class="form-input" id="health-pm25" value="100" min="0" max="500">
                            <div class="form-hint">Delhi: ~100 | WHO limit: 5 | India: 40</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hours Outdoors Daily: <span id="outdoor-display">4</span></label>
                            <input type="range" class="form-range" id="health-outdoor" min="0" max="12" value="4">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pre-existing Conditions</label>
                            <select class="form-select" id="health-conditions">
                                <option value="1">None</option>
                                <option value="1.3">Asthma</option>
                                <option value="1.5">COPD</option>
                                <option value="1.4">Cardiovascular</option>
                                <option value="1.6">Multiple</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="calculateHealthRisk()" style="width: 100%;">Calculate Risk</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Your Results</h3></div>
                    <div class="card-body">
                        <div class="result-box">
                            <div class="result-title">Excess Mortality Risk</div>
                            <div class="result-value danger" id="mortality-risk">--</div>
                            <div class="result-detail">vs WHO guideline (5 ug/m3)</div>
                        </div>
                        <div class="result-box">
                            <div class="result-title">Life-Years Lost</div>
                            <div class="result-value warning" id="life-years-lost">--</div>
                        </div>
                        <div class="result-box">
                            <div class="result-title">Equivalent Cigarettes/Day</div>
                            <div class="result-value" id="cigarette-equiv">--</div>
                            <div class="result-detail">Berkeley Earth method</div>
                        </div>
                    </div>
                    <div class="card-footer">Sources: Lancet GBD 2019, IHME. For awareness only.</div>
                </div>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <div class="card-header"><h3 class="card-title">WHO vs India Standards</h3></div>
                <div class="card-body">
                    <div class="table-wrap">
                        <table class="table">
                            <thead><tr><th>Pollutant</th><th>WHO 2021</th><th>India</th><th>Delhi</th><th>Times Over</th></tr></thead>
                            <tbody>
                                <tr><td>PM2.5 (annual)</td><td>5 ug/m3</td><td>40</td><td>~100</td><td><span class="badge badge-danger">20x</span></td></tr>
                                <tr><td>PM10 (annual)</td><td>15 ug/m3</td><td>60</td><td>~200</td><td><span class="badge badge-danger">13x</span></td></tr>
                                <tr><td>NO2 (annual)</td><td>10 ug/m3</td><td>40</td><td>~50</td><td><span class="badge badge-warning">5x</span></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ECONOMIC -->
        <div class="panel" id="panel-economic">
            <div class="grid grid-4 grid-2-mobile" style="margin-bottom: 1rem;">
                <div class="card stat-card"><div class="stat-value warning">5.4%</div><div class="stat-label">GDP Loss</div></div>
                <div class="card stat-card"><div class="stat-value warning">4.2L Cr</div><div class="stat-label">Annual Cost</div></div>
                <div class="card stat-card"><div class="stat-value danger">1.36B</div><div class="stat-label">Workdays Lost</div></div>
                <div class="card stat-card"><div class="stat-value warning">1.7L Cr</div><div class="stat-label">Healthcare</div></div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg class="icon" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                            Business Loss Calculator
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Employees</label>
                            <input type="number" class="form-input" id="econ-employees" value="100" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Avg Monthly Salary (INR)</label>
                            <input type="number" class="form-input" id="econ-salary" value="50000" min="1000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <select class="form-select" id="econ-city">
                                <option value="285">Delhi (AQI ~285)</option>
                                <option value="142">Mumbai (~142)</option>
                                <option value="178">Kolkata (~178)</option>
                                <option value="98">Chennai (~98)</option>
                                <option value="87">Bengaluru (~87)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="calculateEconomicLoss()" style="width: 100%;">Calculate</button>
                        <div class="result-box" id="econ-result" style="display: none;">
                            <div class="result-title">Annual Productivity Loss</div>
                            <div class="result-value warning" id="econ-loss">--</div>
                            <div class="result-detail" id="econ-detail"></div>
                        </div>
                    </div>
                    <div class="card-footer">World Bank: 1% loss per 10 AQI above 50</div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Impact by Sector</h3></div>
                    <div class="card-body"><div class="chart-container"><canvas id="econChart"></canvas></div></div>
                </div>
            </div>
        </div>

        <!-- POLICY -->
        <div class="panel" id="panel-policy">
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        Policy Effectiveness
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-wrap">
                        <table class="table">
                            <thead><tr><th>Intervention</th><th>Years</th><th>PM2.5 Impact</th><th>Evidence</th></tr></thead>
                            <tbody>
                                <tr><td>Odd-Even</td><td>2016, 2019</td><td><span class="badge badge-warning">-2 to -4%</span></td><td><span class="badge badge-warning">Weak</span></td></tr>
                                <tr><td>BS-VI Fuel</td><td>2020-</td><td><span class="badge badge-success">-10 to -15%</span></td><td><span class="badge badge-success">Strong</span></td></tr>
                                <tr><td>GRAP Stage IV</td><td>2024-25</td><td><span class="badge badge-success">-15 to -20%</span></td><td><span class="badge badge-warning">Moderate</span></td></tr>
                                <tr><td>CNG Buses</td><td>2001-</td><td><span class="badge badge-success">-25%</span></td><td><span class="badge badge-success">Strong</span></td></tr>
                                <tr><td>Stubble Bans</td><td>2015-</td><td><span class="badge badge-danger">No change</span></td><td><span class="badge badge-success">Strong</span></td></tr>
                                <tr><td>Smog Towers</td><td>2021-</td><td><span class="badge badge-danger">&lt;1%</span></td><td><span class="badge badge-success">Strong</span></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">Sources: IIT Delhi, TERI, CSE, CPCB</div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">NCAP Fund Utilization</h3></div>
                    <div class="card-body"><div class="chart-container"><canvas id="ncapChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">GRAP Stages</h3></div>
                    <div class="card-body">
                        <div class="grap-level grap-1"><strong>Stage I (201-300):</strong> Dust control, PUC checks</div>
                        <div class="grap-level grap-2"><strong>Stage II (301-400):</strong> DG set ban, parking 4x</div>
                        <div class="grap-level grap-3"><strong>Stage III (401-450):</strong> Construction ban</div>
                        <div class="grap-level grap-4"><strong>Stage IV (450+):</strong> Truck ban, 50% WFH</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COMPARE -->
        <div class="panel" id="panel-compare">
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header"><h3 class="card-title">City Comparison</h3></div>
                <div class="card-body">
                    <div class="stack-mobile" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">City 1</label>
                            <select class="form-select" id="compare-city1" onchange="updateComparison()">
                                <option value="delhi">Delhi</option>
                                <option value="mumbai">Mumbai</option>
                                <option value="kolkata">Kolkata</option>
                                <option value="chennai">Chennai</option>
                                <option value="bangalore">Bengaluru</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">City 2</label>
                            <select class="form-select" id="compare-city2" onchange="updateComparison()">
                                <option value="mumbai" selected>Mumbai</option>
                                <option value="delhi">Delhi</option>
                                <option value="kolkata">Kolkata</option>
                                <option value="chennai">Chennai</option>
                                <option value="bangalore">Bengaluru</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">International</label>
                            <select class="form-select" id="compare-city3" onchange="updateComparison()">
                                <option value="beijing">Beijing</option>
                                <option value="london">London</option>
                                <option value="newyork">New York</option>
                                <option value="singapore">Singapore</option>
                            </select>
                        </div>
                    </div>
                    <div id="comparison-result" class="grid grid-3 grid-2-mobile"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3 class="card-title">Comparison Chart</h3></div>
                <div class="card-body"><div class="chart-container"><canvas id="compareChart"></canvas></div></div>
            </div>
        </div>

        <!-- MAP -->
        <div class="panel" id="panel-map">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg class="icon" viewBox="0 0 24 24"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/></svg>
                        Live Air Quality Map
                    </h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="india-map"></div>
                </div>
                <div class="card-footer">Click markers for details. Data from WAQI API.</div>
            </div>
        </div>

        <!-- HISTORY -->
        <div class="panel" id="panel-history">
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header"><h3 class="card-title">Delhi PM2.5 Trend (2015-2025)</h3></div>
                <div class="card-body"><div class="chart-container" style="height: 250px;"><canvas id="historyChart"></canvas></div></div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Seasonal Pattern</h3></div>
                    <div class="card-body"><div class="chart-container"><canvas id="seasonalChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Key Events</h3></div>
                    <div class="card-body">
                        <div class="timeline-item">
                            <div class="timeline-date">Nov 2016</div>
                            <div class="timeline-content"><div class="timeline-title">Great Smog</div><div class="timeline-desc">AQI 999+, schools closed</div></div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">Apr 2020</div>
                            <div class="timeline-content"><div class="timeline-title">COVID Lockdown</div><div class="timeline-desc">PM2.5 dropped 50%+</div></div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">Dec 2025</div>
                            <div class="timeline-content"><div class="timeline-title">Zero Good Days</div><div class="timeline-desc">No Good AQI day all year</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACCOUNTABILITY -->
        <div class="panel" id="panel-accountability">
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header"><h3 class="card-title">Political Accountability</h3></div>
                <div class="card-body">
                    <div class="table-wrap">
                        <table class="table">
                            <thead><tr><th>Promise</th><th>By</th><th>Year</th><th>Status</th></tr></thead>
                            <tbody>
                                <tr><td>Clean air in 3 years</td><td>Delhi CM</td><td>2020</td><td><span class="badge badge-danger">Failed</span></td></tr>
                                <tr><td>40% PM2.5 cut by 2026</td><td>MoEFCC</td><td>2019</td><td><span class="badge badge-warning">Behind</span></td></tr>
                                <tr><td>End stubble burning</td><td>Punjab CM</td><td>2021-24</td><td><span class="badge badge-danger">Repeat Fail</span></td></tr>
                                <tr><td>Smog towers work</td><td>DPCC</td><td>2021</td><td><span class="badge badge-danger">Ineffective</span></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Court Orders</h3></div>
                    <div class="card-body">
                        <div class="table-wrap">
                            <table class="table">
                                <thead><tr><th>Order</th><th>Compliance</th></tr></thead>
                                <tbody>
                                    <tr><td>Ban 10yr+ diesel vehicles</td><td><span class="badge badge-warning">Partial</span></td></tr>
                                    <tr><td>Implement GRAP proactively</td><td><span class="badge badge-success">Yes</span></td></tr>
                                    <tr><td>Stop stubble burning</td><td><span class="badge badge-danger">No</span></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">RTI Template</h3></div>
                    <div class="card-body">
                        <div class="code-box">Subject: RTI Act 2005

To: CPIO, [DPCC/CPCB]

1. NCAP funds allocated to [city]
2. Fund utilization %
3. PM2.5 data for [month]
4. Challans issued under GRAP

[Your details]</div>
                        <button class="btn btn-primary" onclick="copyRTI()" style="margin-top: 0.5rem;">Copy Template</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOOLS -->
        <div class="panel" id="panel-tools">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Embed Widget</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <select class="form-select" id="widget-city">
                                <option value="delhi">Delhi</option>
                                <option value="mumbai">Mumbai</option>
                                <option value="bangalore">Bengaluru</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="generateWidget()" style="width: 100%;">Generate Code</button>
                        <div class="code-box" id="widget-code" style="display: none; margin-top: 0.5rem;"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Data Export</h3></div>
                    <div class="card-body">
                        <button class="btn" onclick="exportData('json')" style="width: 100%; margin-bottom: 0.5rem;">
                            <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            Download JSON
                        </button>
                        <button class="btn" onclick="exportData('csv')" style="width: 100%;">
                            <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            Download CSV
                        </button>
                    </div>
                </div>
            </div>
            <div class="card" style="margin-top: 1rem;">
                <div class="card-header"><h3 class="card-title">PM2.5 to AQI Converter</h3></div>
                <div class="card-body">
                    <div class="stack-mobile">
                        <div class="form-group">
                            <label class="form-label">PM2.5 (ug/m3)</label>
                            <input type="number" class="form-input" id="pm25-input" placeholder="Enter value">
                        </div>
                        <div class="form-group">
                            <label class="form-label">India AQI</label>
                            <input type="text" class="form-input" id="india-aqi-output" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">US EPA AQI</label>
                            <input type="text" class="form-input" id="us-aqi-output" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary" onclick="convertPM25()" style="width: 100%;">Convert</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESOURCES -->
        <div class="panel" id="panel-resources">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Health Studies</h3></div>
                    <div class="card-body">
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><a href="https://www.thelancet.com/journals/lanplh/article/PIIS2542-5196(20)30298-9/fulltext" target="_blank">Lancet GBD 2019: India Analysis</a></div>
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><a href="https://www.healthdata.org/sites/default/files/2024-06/soga-2024-report.pdf" target="_blank">State of Global Air 2024</a></div>
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><a href="https://www.who.int/publications/i/item/9789240034228" target="_blank">WHO Air Quality Guidelines 2021</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Source Apportionment</h3></div>
                    <div class="card-body">
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><a href="https://www.teriin.org/sites/default/files/2018-08/Report_SA_AQM-Delhi-NCR_0.pdf" target="_blank">TERI-ARAI Delhi NCR</a></div>
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><a href="https://urbanemissions.info/wp-content/uploads/docs/2023-02-MDPI-Sus-DelhiAQ-Review.pdf" target="_blank">Urban Emissions 1990-2022</a></div>
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><a href="https://www.downtoearth.org.in/air/from-episodic-smog-to-structural-pollution-why-vehicles-remain-delhis-biggest-challenge" target="_blank">CSE Vehicles Analysis</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Policy and Legal</h3></div>
                    <div class="card-body">
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg><a href="https://caqm.nic.in" target="_blank">CAQM (GRAP Orders)</a></div>
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg><a href="https://prana.cpcb.gov.in/" target="_blank">PRANA Portal (NCAP)</a></div>
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg><a href="https://indiankanoon.org/search/?formInput=air%20pollution" target="_blank">Indian Kanoon (Court Orders)</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Live Data</h3></div>
                    <div class="card-body">
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg><a href="https://aqicn.org/city/delhi/" target="_blank">WAQI / AQICN</a></div>
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg><a href="https://app.cpcbccr.com/ccr/#/caaqm-dashboard-all/caaqm-landing" target="_blank">CPCB Dashboard</a></div>
                        <div class="resource-link"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg><a href="https://safar.tropmet.res.in/" target="_blank">SAFAR Forecast</a></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>Vayu Smriti | <a href="https://github.com/Varnasr/vayu-smriti">GitHub</a></p>
        <p style="margin-top: 0.25rem;">Data: WAQI, CPCB, WHO, Lancet, IHME</p>
    </footer>

    <script>
        // CONFIG
        const WAQI_TOKEN = 'demo';
        const CITIES = {
            delhi: { name: 'Delhi', lat: 28.61, lon: 77.21, query: 'delhi' },
            mumbai: { name: 'Mumbai', lat: 19.08, lon: 72.88, query: 'mumbai' },
            kolkata: { name: 'Kolkata', lat: 22.57, lon: 88.36, query: 'kolkata' },
            chennai: { name: 'Chennai', lat: 13.08, lon: 80.27, query: 'chennai' },
            bangalore: { name: 'Bengaluru', lat: 12.97, lon: 77.59, query: 'bangalore' },
            hyderabad: { name: 'Hyderabad', lat: 17.39, lon: 78.49, query: 'hyderabad' },
            patna: { name: 'Patna', lat: 25.59, lon: 85.14, query: 'patna' },
            lucknow: { name: 'Lucknow', lat: 26.85, lon: 80.95, query: 'lucknow' },
            beijing: { name: 'Beijing', lat: 39.90, lon: 116.41, query: 'beijing' },
            london: { name: 'London', lat: 51.51, lon: -0.13, query: 'london' },
            newyork: { name: 'New York', lat: 40.71, lon: -74.01, query: 'new york' },
            singapore: { name: 'Singapore', lat: 1.35, lon: 103.82, query: 'singapore' }
        };
        let aqiData = {}, charts = {}, map = null;

        // THEME
        function toggleTheme() {
            const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t);
            initAllCharts();
        }

        // NAV
        function showPanel(p) {
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('panel-' + p).classList.add('active');
            event.target.closest('.tab').classList.add('active');
            if (p === 'map' && !map) initMap();
            if (p === 'compare') updateComparison();
        }

        // AQI UTILS
        function getAQIClass(a) { return a <= 50 ? 'good' : a <= 100 ? 'mod' : a <= 200 ? 'poor' : a <= 300 ? 'vpoor' : a <= 400 ? 'severe' : 'hazard'; }
        function getAQIColor(a) { return a <= 50 ? '#22C55E' : a <= 100 ? '#EAB308' : a <= 200 ? '#F97316' : a <= 300 ? '#EF4444' : a <= 400 ? '#7C3AED' : '#831843'; }

        // FETCH
        async function fetchAQI(k) {
            try {
                const r = await fetch(`https://api.waqi.info/feed/${CITIES[k].query}/?token=${WAQI_TOKEN}`);
                const d = await r.json();
                if (d.status === 'ok' && d.data.aqi !== '-') return { aqi: parseInt(d.data.aqi), pm25: d.data.iaqi?.pm25?.v };
            } catch (e) {}
            return null;
        }
        async function fetchAllAQI() {
            const keys = ['delhi', 'mumbai', 'kolkata', 'chennai', 'bangalore', 'hyderabad', 'patna', 'lucknow'];
            const results = await Promise.all(keys.map(k => fetchAQI(k)));
            results.forEach((r, i) => { if (r) aqiData[keys[i]] = r; });
            updateTicker(); updateDashboard(); initAllCharts();
            document.getElementById('ticker-update').textContent = new Date().toLocaleTimeString();
        }
        function updateTicker() {
            document.getElementById('aqi-ticker').innerHTML = Object.entries(aqiData).map(([k, d]) =>
                `<div class="ticker-item"><span class="ticker-city">${CITIES[k]?.name || k}</span><span class="ticker-aqi ${getAQIClass(d.aqi)}">${d.aqi}</span></div>`
            ).join('');
        }
        function updateDashboard() {
            const el = document.getElementById('delhi-live-aqi');
            if (aqiData.delhi) { el.textContent = aqiData.delhi.aqi; el.className = 'stat-value ' + (aqiData.delhi.aqi > 200 ? 'danger' : 'warning'); }
        }

        // CALCULATORS
        function calculateSafeHours() {
            const aqi = +document.getElementById('safe-aqi').value, act = +document.getElementById('safe-activity').value, hlt = +document.getElementById('safe-health').value;
            let hrs = aqi <= 50 ? 24 : aqi <= 200 ? Math.max(0.5, 12 - (aqi - 50) / 30) : aqi <= 400 ? Math.max(0.25, 4 - (aqi - 200) / 100) : 0;
            hrs = Math.max(0, hrs / (act * hlt));
            document.getElementById('safe-result').style.display = 'block';
            const el = document.getElementById('safe-hours');
            el.textContent = hrs === 0 ? 'AVOID OUTDOORS' : hrs.toFixed(1) + ' hours';
            el.style.color = hrs < 2 ? '#EF4444' : hrs < 4 ? '#F59E0B' : '#22C55E';
            document.getElementById('safe-advice').textContent = aqi > 300 ? 'Stay indoors. Use N95 mask if unavoidable.' : aqi > 200 ? 'Avoid outdoor exercise.' : aqi > 100 ? 'Reduce prolonged exertion.' : 'Acceptable for most.';
        }
        function calculateHealthRisk() {
            const age = +document.getElementById('health-age').value, pm = +document.getElementById('health-pm25').value, out = +document.getElementById('health-outdoor').value, cond = +document.getElementById('health-conditions').value;
            const baseRR = Math.exp(0.1 * Math.log(1 + 5 / 2.5)), currRR = Math.exp(0.1 * Math.log(1 + pm / 2.5));
            const risk = ((currRR / baseRR) - 1) * 100 * cond * (out / 8);
            const yrs = (risk / 100) * (75 - age) * 0.3;
            const cig = (pm * out / 24) / 22;
            document.getElementById('mortality-risk').textContent = '+' + risk.toFixed(1) + '%';
            document.getElementById('life-years-lost').textContent = yrs.toFixed(1) + ' years';
            document.getElementById('cigarette-equiv').textContent = cig.toFixed(1);
        }
        document.getElementById('health-outdoor')?.addEventListener('input', e => document.getElementById('outdoor-display').textContent = e.target.value);

        function calculateEconomicLoss() {
            const emp = +document.getElementById('econ-employees').value, sal = +document.getElementById('econ-salary').value, aqi = +document.getElementById('econ-city').value;
            const loss = Math.max(0, (aqi - 50) / 10) * 0.01 * sal * 12 * emp;
            document.getElementById('econ-result').style.display = 'block';
            document.getElementById('econ-loss').textContent = (loss / 100000).toFixed(1) + ' Lakhs/yr';
            document.getElementById('econ-detail').textContent = 'Productivity loss: ' + (Math.max(0, (aqi - 50) / 10)).toFixed(1) + '%';
        }

        // COMPARE
        async function updateComparison() {
            const c = [document.getElementById('compare-city1').value, document.getElementById('compare-city2').value, document.getElementById('compare-city3').value];
            await Promise.all(c.map(async k => { if (!aqiData[k]) { const r = await fetchAQI(k); if (r) aqiData[k] = r; } }));
            document.getElementById('comparison-result').innerHTML = c.map(k => {
                const d = aqiData[k] || { aqi: '--' };
                return `<div class="card stat-card"><div style="font-size:0.75rem;font-weight:600;margin-bottom:0.25rem;">${CITIES[k]?.name || k}</div><div class="stat-value" style="color:${getAQIColor(d.aqi)}">${d.aqi}</div></div>`;
            }).join('');
            if (charts.compare) { charts.compare.data.labels = c.map(k => CITIES[k]?.name || k); charts.compare.data.datasets[0].data = c.map(k => aqiData[k]?.aqi || 0); charts.compare.data.datasets[0].backgroundColor = c.map(k => getAQIColor(aqiData[k]?.aqi || 0)); charts.compare.update(); }
        }

        // MAP
        function initMap() {
            map = L.map('india-map').setView([22.5, 78.5], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
            Object.entries(CITIES).forEach(([k, c]) => {
                if (!c.lat || /beijing|london|newyork|singapore/.test(k)) return;
                const d = aqiData[k], aqi = d?.aqi || '?';
                L.circleMarker([c.lat, c.lon], { radius: 10, fillColor: getAQIColor(aqi), color: '#fff', weight: 2, fillOpacity: 0.8 }).addTo(map).bindPopup(`<b>${c.name}</b><br>AQI: ${aqi}`);
            });
        }

        // CHARTS
        function initAllCharts() {
            const dark = document.documentElement.getAttribute('data-theme') === 'dark';
            const txt = dark ? '#94A3B8' : '#64748B', grid = dark ? '#334155' : '#E2E8F0';
            Chart.defaults.color = txt;
            Object.values(charts).forEach(c => c?.destroy?.()); charts = {};
            const opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: grid } }, x: { grid: { display: false } } } };

            const metroCtx = document.getElementById('metroChart');
            if (metroCtx) {
                const keys = ['delhi', 'mumbai', 'kolkata', 'chennai', 'bangalore', 'hyderabad'];
                charts.metro = new Chart(metroCtx, { type: 'bar', data: { labels: keys.map(k => CITIES[k].name), datasets: [{ data: keys.map(k => aqiData[k]?.aqi || 0), backgroundColor: keys.map(k => getAQIColor(aqiData[k]?.aqi || 0)) }] }, options: { ...opts, scales: { ...opts.scales, y: { ...opts.scales.y, max: 400 } } } });
            }
            const regionCtx = document.getElementById('regionChart');
            if (regionCtx) {
                charts.region = new Chart(regionCtx, { type: 'bar', data: { labels: ['Delhi', 'Lucknow', 'Patna', 'Chennai', 'Bengaluru', 'Hyderabad'], datasets: [{ label: 'North', data: [aqiData.delhi?.aqi || 0, aqiData.lucknow?.aqi || 0, aqiData.patna?.aqi || 0, null, null, null], backgroundColor: '#EF4444' }, { label: 'South', data: [null, null, null, aqiData.chennai?.aqi || 0, aqiData.bangalore?.aqi || 0, aqiData.hyderabad?.aqi || 0], backgroundColor: '#22C55E' }] }, options: { ...opts, plugins: { legend: { display: true } }, scales: { ...opts.scales, y: { ...opts.scales.y, max: 400 } } } });
            }
            const econCtx = document.getElementById('econChart');
            if (econCtx) { charts.econ = new Chart(econCtx, { type: 'doughnut', data: { labels: ['Healthcare', 'Productivity', 'Deaths', 'Agri'], datasets: [{ data: [170, 120, 95, 35], backgroundColor: ['#EF4444', '#F59E0B', '#7C3AED', '#22C55E'] }] }, options: { responsive: true, maintainAspectRatio: false } }); }
            const ncapCtx = document.getElementById('ncapChart');
            if (ncapCtx) { charts.ncap = new Chart(ncapCtx, { type: 'bar', data: { labels: ['Delhi', 'Mumbai', 'Kolkata', 'Chennai'], datasets: [{ label: 'Allocated', data: [450, 380, 290, 220], backgroundColor: '#3B82F6' }, { label: 'Used', data: [180, 220, 145, 165], backgroundColor: '#22C55E' }] }, options: opts }); }
            const compareCtx = document.getElementById('compareChart');
            if (compareCtx) { charts.compare = new Chart(compareCtx, { type: 'bar', data: { labels: ['A', 'B', 'C'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#ccc', '#ccc', '#ccc'] }] }, options: { ...opts, scales: { ...opts.scales, y: { ...opts.scales.y, max: 500 } } } }); }
            const historyCtx = document.getElementById('historyChart');
            if (historyCtx) { charts.history = new Chart(historyCtx, { type: 'line', data: { labels: ['2015', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25'], datasets: [{ label: 'PM2.5', data: [122, 134, 128, 115, 108, 84, 96, 99, 102, 105, 100], borderColor: '#7C3AED', fill: true, backgroundColor: 'rgba(124,58,237,0.1)', tension: 0.4 }, { label: 'WHO', data: [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5], borderColor: '#22C55E', borderDash: [5, 5] }] }, options: { ...opts, scales: { ...opts.scales, y: { ...opts.scales.y, max: 150 } } } }); }
            const seasonalCtx = document.getElementById('seasonalChart');
            if (seasonalCtx) { charts.seasonal = new Chart(seasonalCtx, { type: 'line', data: { labels: ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'], datasets: [{ data: [320, 280, 180, 120, 110, 90, 80, 75, 95, 180, 380, 350], borderColor: '#EF4444', fill: true, backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.4 }] }, options: { ...opts, scales: { ...opts.scales, y: { ...opts.scales.y, max: 450 } } } }); }
        }

        // TOOLS
        function exportData(fmt) {
            const d = { timestamp: new Date().toISOString(), source: 'Vayu Smriti / WAQI', cities: aqiData };
            if (fmt === 'json') { download(new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' }), 'vayu-smriti.json'); }
            else { let csv = 'City,AQI,PM2.5\n'; Object.entries(aqiData).forEach(([k, v]) => csv += `${CITIES[k]?.name || k},${v.aqi},${v.pm25 || ''}\n`); download(new Blob([csv], { type: 'text/csv' }), 'vayu-smriti.csv'); }
        }
        function download(b, n) { const u = URL.createObjectURL(b), a = document.createElement('a'); a.href = u; a.download = n; a.click(); URL.revokeObjectURL(u); }
        function generateWidget() { const c = document.getElementById('widget-city').value; document.getElementById('widget-code').style.display = 'block'; document.getElementById('widget-code').textContent = `<iframe src="https://aqicn.org/city/${c}/" width="300" height="150" style="border:0;border-radius:8px;"></iframe>`; }
        function copyRTI() { navigator.clipboard.writeText(document.querySelector('#panel-accountability .code-box').textContent); alert('Copied!'); }
        function convertPM25() {
            const pm = +document.getElementById('pm25-input').value; if (!pm) return;
            let ia = pm <= 30 ? pm * 50 / 30 : pm <= 60 ? 50 + (pm - 30) * 50 / 30 : pm <= 90 ? 100 + (pm - 60) * 100 / 30 : pm <= 120 ? 200 + (pm - 90) * 100 / 30 : pm <= 250 ? 300 + (pm - 120) * 100 / 130 : 400 + (pm - 250) * 100 / 130;
            let ua = pm <= 12 ? pm * 50 / 12 : pm <= 35.4 ? 50 + (pm - 12) * 50 / 23.4 : pm <= 55.4 ? 100 + (pm - 35.4) * 50 / 20 : pm <= 150.4 ? 150 + (pm - 55.4) * 50 / 95 : pm <= 250.4 ? 200 + (pm - 150.4) * 100 / 100 : 300 + (pm - 250.4) * 100 / 149.6;
            document.getElementById('india-aqi-output').value = Math.round(ia);
            document.getElementById('us-aqi-output').value = Math.round(ua);
        }

        // INIT
        document.addEventListener('DOMContentLoaded', async () => { await fetchAllAQI(); initAllCharts(); setInterval(fetchAllAQI, 600000); });
    </script>
</body>
</html>
